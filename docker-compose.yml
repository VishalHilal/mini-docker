version: '3.8'

services:
  # Mini-docker engine API server
  engine:
    build:
      context: .
      dockerfile: Dockerfile
      target: build
    container_name: mini-docker-engine
    restart: unless-stopped
    ports:
      - "${ENGINE_PORT:-8080}:8080"
    volumes:
      - mini-docker-registry:/tmp/mini-docker
      - /var/run/docker.sock:/var/run/docker.sock
    privileged: true
    command: ["go", "run", "./cmd/engine/main.go"]
    working_dir: /src
    env_file:
      - .env
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/images"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - mini-docker-net

  # CLI client container (for testing)
  cli:
    build:
      context: .
      dockerfile: Dockerfile
      target: build
    container_name: mini-docker-cli
    depends_on:
      engine:
        condition: service_healthy
    volumes:
      - ./examples:/examples:ro
      - mini-docker-registry:/tmp/mini-docker
    command: ["sleep", "infinity"]
    working_dir: /src
    environment:
      - ENGINE_URL=http://engine:8080
    networks:
      - mini-docker-net
    profiles:
      - testing

  # Development environment with hot reload
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: mini-docker-dev
    ports:
      - "8080:8080"
    volumes:
      - .:/src
      - /tmp/mini-docker:/tmp/mini-docker
      - /var/run/docker.sock:/var/run/docker.sock
    privileged: true
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    networks:
      - mini-docker-net
    profiles:
      - dev

networks:
  mini-docker-net:
    driver: bridge

volumes:
  mini-docker-registry:
    driver: local
